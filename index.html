<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>Natcats</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <style type="text/css">
            .pagination {
                justify-content: center;
            }

            #result ul {
                list-style-type: none none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: center;
            }

            #result ul li {
                display: flex;
                flex-direction: column;
                width: 80px;
                height: 80px;
                background: #888;
                border: 1px solid #fff;
                justify-content: center;
                align-items: center;
                position: relative;
            }

            #result ul li span {
                font-weight: bold;
                font-size: 0.8rem;
                margin-bottom: 0;
            }

            #result ul li .buy {
                position: absolute;
                top: 0;
                right: 0;
                background: black;
                color: white;
                font-size: 10px;
                padding: 2px 3px;
                text-decoration: none;
            }

            #result ul li .buy:hover {
                text-decoration: underline;
            } 

            .pixel-image {
                width: 64px;
                height: 64px;
                image-rendering: pixelated;
            }

            .h6 a { color: white; text-decoration: none; }
        </style>
    </head>
    <body class="bg-dark p-5 text-center">
        <div class="container-fluid">
            <div class="row">
                <div class="col-4">
                    <div id="filter" class="mb-4">
                        <h4>Filter</h4>
                    </div>
                </div>
                <div class="col-8">
                    <h2>Natcats</h2>

                    <nav aria-label="Page navigation">
                        <ul class="pagination text-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#prev">Previous</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#1">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#2">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#3">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#4">4</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#5">5</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#6">6</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#7">7</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#8">8</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#9">9</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#next">Next</a>
                            </li>
                        </ul>
                    </nav>

                    <div id="result" class="mb-4">Loading data..</div>
                    
                    <nav aria-label="Page navigation">
                        <ul class="pagination text-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#prev">Previous</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#1">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#2">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#3">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#4">4</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#5">5</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#6">6</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#7">7</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#8">8</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#9">9</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#next">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <script>
            let natcats = []
            let filtered_natcats = []

            const itemsPerPage = 1000
            const result = document.querySelector('#result')
            let numberOfPages = 9

            let currentPage = 1

            const setActivePage = page=>{
                // reset all active states first
                document.querySelectorAll('.page-item').forEach(item=>{
                    item.classList.remove('active')
                }
                )
                // add active state to current page
                document.querySelectorAll(`.page-link[href="#${page}"]`).forEach(item=>{
                    item.parentNode.classList.add('active')
                }
                )
            }

            const showItems = page => {
                const startIndex = (page - 1) * itemsPerPage
                const itemsToShow = filtered_natcats.slice(startIndex, startIndex + itemsPerPage)

                let html = '<ul>'

                itemsToShow.forEach(item => {
                    let id = item.name.replace('Natcat #','')
                    html += `
                        <li title="${item.name}">
                            <img class="pixel-image" src="./img/${id}.png">
                            <span class="h6"><a href="./img/${id}.png" target="_blank">${id}</a></span>
                            <a href="${item.attributes.find(a => a.trait_type === 'magic_eden_link').value}" class="buy" target="_blank">buy</a>
                        </li>`
                })

                html += '</ul>'

                result.innerHTML = html

                setActivePage(page)
            }

            document.querySelectorAll('.page-link').forEach(item=>{
                item.addEventListener('click', event=>{
                    event.preventDefault();

                    const page = event.target.getAttribute('href').replace('#', '')

                    if (page === 'prev') {
                        currentPage--
                    } else if (page === 'next') {
                        currentPage++
                    } else {
                        currentPage = parseInt(page)
                    }

                    document.querySelectorAll('.page-link[href="#prev"]').forEach(item=>{
                        item.parentNode.classList[currentPage === 1 ? 'add' : 'remove']('disabled')
                    }
                    )
                    document.querySelectorAll('.page-link[href="#next"]').forEach(item=>{
                        item.parentNode.classList[currentPage === numberOfPages ? 'add' : 'remove']('disabled')
                    }
                    )

                    showItems(currentPage)
                }
                )
            }
            )

            function makeFilter() {
                const keys = []

                natcats[0].attributes.forEach(attr => {
                    keys.push(attr.trait_type)

                    document.querySelector('#filter').innerHTML += `<select class="form-select mb-2" id="${attr.trait_type}" aria-label="Default select example">
                        <option value="" selected>${attr.trait_type}</option>
                    </select>`
                })

                const options = []

                natcats.forEach(cat => {
                    cat.attributes.forEach(attr => {
                        let f = options.filter(v => v.key === attr.trait_type)

                        if(f.length) {
                            let val = f[0].values.filter(v => v.value === attr.value)

                            
                            if(val.length) {
                               val[0].count = val[0].count + 1
                            } else {
                                f[0].values.push({
                                    value: attr.value,
                                    count: 1
                                })
                            }
                        } else {
                            options.push({
                                key: attr.trait_type,
                                values: [{
                                    value: attr.value,
                                    count: 1
                                }]
                            })
                        }
                    })
                })

                options.forEach(a => {
                    if(!['inscription_number', 'magic_eden_link'].includes(a.key)) {
                        a.values.forEach(b => {
                            document.querySelector(`#${a.key}`).innerHTML += `<option value="${b.value}">${b.value} (${b.count})</option>`
                        })
                    }
                })

                document.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', e => {
                        let name = e.target.getAttribute('id')
                        let value = e.target.value === "true" ? true : e.target.value === "false" ? false : e.target.value

                        if(value !== '') {
                            console.log(`${name}: ${value}`)

                            filtered_natcats = natcats.filter(n => {
                                let match = n.attributes.filter(a => a.trait_type === name && a.value === value)

                                return match.length
                            })

                            showItems(1)
                        } else {
                            filtered_natcats = natcats
                            showItems(1)
                        }
                    })
                })
            }

            async function init() {
                natcats = await fetch('./traits.json').then(res=>res.json()).catch(e=>console.log(e))

                filtered_natcats = natcats

                makeFilter()

                // load first page by default
                showItems(currentPage)
            }

            init()
        </script>
    </body>
</html>
